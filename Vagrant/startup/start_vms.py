#!/usr/bin/env python3


import subprocess
from typing import List

VBOXMANAGE = "/usr/bin/vboxmanage"
MASTER_PREFIX = "masters_lab-cluster"
WORKER_PREFIX = "workers_lab-cluster"


def find_vms() -> List[str]:
    vms = list()
    vm_list = subprocess.check_output([VBOXMANAGE, "list", "vms"])
    for line in vm_list.decode("utf-8").split("\n"):
        line = line.strip()
        if not line:
            continue
        name, uuid = line.split()
        name = name.replace("\"", "")
        uuid = uuid.replace("{", "").replace("}", "")
        if name.startswith(MASTER_PREFIX) or name.startswith(WORKER_PREFIX):
            vms.append(uuid)
    return vms


def start_vm(vm: str):
    process = subprocess.Popen([VBOXMANAGE, "startvm", vm, "--type", "headless"],
                               stdout=subprocess.PIPE,
                               stderr=subprocess.PIPE)
    _output, error = process.communicate()
    error = error.decode("utf-8")
    if process.returncode != 0:
        if "is already locked by a session" in error:
            return True
        return False
    return True



if __name__ == "__main__":
    vms = find_vms()
    for vm in vms:
        success = start_vm(vm)
        print(f"{vm} - {success}")
