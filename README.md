# malwarETL-k8s
## K8s policies/setup files for malwarETL installation

This is a set of scripts and configurations to install k8s on a local bare-metal repo, which I then run malwarETL on 
top of. 

This has a few advantages: 
  1) kubespray + ansible means that adding/removing/updating nodes is done in a scripted way, rather than manually tweaking nodes.
  2) using kubespray means it's using kubeadm under the hood, we we're still getting the recommended settings for much of the node setup.


Checklist for creating a new cluster (yes, I can automate this more...gimme time):
 - [ ] run `ansible -i lab_cluster.yml masters -m ping` and with `workers` to make sure you have the ssh keys trusted
 - [ ] run `ansible-playbook -i lab_cluster.yml site.yml` to fix a missing package in Ubuntu on raspberry PIs.
 - [ ] run `ansible-playbook -i lab_cluster.yml kubespray/cluster.yml` to install kubespray
 - [ ] grab the kubernetes config from `ansible/artifacts/admin.conf` , put it in your own ~/.kube/config, and modify the dest IP to match the IP of master-1
 - [ ] install the csi-smb driver: `helm install csi-driver-smb csi-driver-smb/csi-driver-smb --namespace kube-system --version v1.3.0`
   - [ ] you may need to add the csi-smb helm repo: `helm repo add csi-driver-smb https://raw.githubusercontent.com/kubernetes-csi/csi-driver-smb/master/charts`
 - [ ] install vault via helm
   - [ ] add vault smb secrets and vault storageclass first (yes, this is defeating the point of vault a bit. have a chicken/egg problem that I'll solve later)
   - [ ] initialize the vault `kubectl exec vault-0 -- vault operator init -key-shares=1-key-threshold=1 -format=json > cluster-keys.json`
   - [ ] make sure secrets are appearing in vault correctly
 - [ ] install elasticsearch via helm (see malwaretl-es for notes)
   - [ ] extract the elastic password from the installation with `kubectl get secret malwaretl-cluster-es-elastic-user -n es -o go-template='{{.data.elastic | base64decode}}'`
 - [ ] install the various malware collectors in their namespace
   - [ ] Update the collectors secrets with the ES password from above
 - [ ] install the ti-collector in its namespace
 - [ ] install the pastebin collector in its namespace
   - [ ] make sure you have a docker registry secret names "registrycreds" created to pull the private image



### Vault secrets
Sadly, I have not yet found a good way to automate the addition of secrets and policies to vault during the helm install.
I'm sure a way exists, and it'll probably be an ansible job, I just haven't written it yet, since it involves not just
ssh'ing to a host, but kube exec as well, which is a step I haven't worked out with ansible yet. That makes this step 
tedious as hell. 

To install it and have  it use the cluster storage, you'll need to create the storageclass for it. That requires 
a kubernetes secret, stored in vault-secrets. I have, sadly, not yet found a way to avoid the chicken and egg problem
of vault needing outside-of-the-cluster persistent storage (and therefore a password).

From a brand-new install  you'll first have to initialize the vault pod: 
```kubectl exec vault-0 -- vault operator init -key-shares=1 -key-threshold=1 -format=json > cluster-keys.json
```

keep that `cluster-keys.json` file around, as it'll have your passwords for later interaction with vault

Then you'll need to unseal the vault on the pod:
```kubectl exec vault-0 -- vault operator unseal $VAULT_UNSEAL_KEY
```
(assuming the VAULT_UNSEAL_KEY value from the cluster-keys.json file is put into that env variable)

Then, shell into the vault pod:
```kubectl exec --stdin=true --tty=true vault-0 -- /bin/sh```


Next, enable kubernetes authentication
```vault auth enable kubernetes```

paste the script from `secrets_structure.md` onto the pod, set the passwords, then run it
Then do the same for `policies.md` and `roles.md`