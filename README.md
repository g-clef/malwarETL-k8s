# malwarETL-k8s
## K8s policies/setup files for malwarETL installation

This is a set of scripts and configurations to install k8s on a local bare-metal repo, which I then run malwarETL on 
top of. 

This has a few advantages: 
  1) kubespary + ansible means that adding/removing/updating nodes is done in a scripted way, rather than manually tweaking nodes.
  2) using kubespray means it's using kubeadm under the hood, we we're still getting the recommended settings for much of the node setup.

## Note on virtualbox

DO NOT use the virtualbox that's provided by Ubuntu. I had a bunch of problems with it. Install it from the .deb from 
virtualbox.org (or add their apt repo and install it via apt). I had to remove a lot of 
other auto-installed components after installing the ubuntu packaged version, as well. You should run: 
```
sudo apt-get remove virtualb*
sudo apt-get remove vbox*
```

in an empty directory before installing the virtualbox deb. Note: it will be tempting to run an `apt-get autoremove` or 
`apt-get clean` after uninstalling the virtualbox components...that's *technically* the right thing to do, but it will
remove a bunch of components that the deb will be looking for and won't trigger an installation of itself. The fact 
that a headless virtualization system needs a whole pile of xwindows stuff is somewhat sad, but here we are.

## Note on ubuntu interfaces

Ubuntu 18.04 (and probably later) install parts of lxc by default (which is part of why I started with LXC in this
whole saga). That includes some processes that create network interfaces for lxc automatically. That caused some confusion
when I would try to headlessly bring up vms with vagrant. (since vagrant would ask which interface to bridge to 
every time.) To disable those, I ended up running`systemctl disable libvirt-guests` and `systemctl disable libvirtd`. 
It's not strictly necessary to do that, you could just ignore them, but I didn't like having extra 
stuff confusing any troubleshooting, especially other virtualization systems that I wasn't using.

Checklist for creating a new cluster (yes, I can automate this more...gimme time):
 - [ ] run vagrant on vms to create machines
 - [ ] run `ansible -i lab_cluster.yml masters -m ping` and with `workers` to make sure you have the ssh keys trusted
 - [ ] run `ansible-playbook -i lab_cluster.yml site.yml` to fix the default gateways of the pods
 - [ ] run `ansible-playbook -i lab_cluster.yml kubespray/cluster.yml` to install kubespray
 - [ ] grab the kubernetes config from lab-cluster-master-1:/home/root/.kube/config , put it in your own ~/.kube/config, and modify the dest IP to match the IP of master-1
 - [ ] install the csi-smb driver: `helm install csi-driver-smb csi-driver-smb/csi-driver-smb --namespace kube-system --version v1.3.0`
   - [ ] you may need to add the csi-smb helm repo: `helm repo add csi-driver-smb https://raw.githubusercontent.com/kubernetes-csi/csi-driver-smb/master/charts`
 - [ ] add the daemonset and certificate secrets to handle the self-signed cert for prefect connections (part of the malwaETL-prefect repo)
 - [ ] install the prefect agent in its namespace
 - [ ] install elasticsearch via helm (see malwaretl-es for notes)
   - [ ] extract the elastic password from the installation with `kubectl get secret malwaretl-cluster-es-elastic-user -n es -o go-template='{{.data.elastic | base64decode}}'`
 - [ ] install the various malware collectors in their namespace
 - [ ] install the ti-collector in its namespace
 - [ ] install the pastebin collector in its namespace